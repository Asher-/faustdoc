<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Optimizing - Faust Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/docco.min.css">
        <link href="/css/faust.css" rel="stylesheet">
        <link href="/css/quickref.css" rel="stylesheet">
        <link href="/rail/railroad-diagrams.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Faust Documentation</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Faust Manual <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../introduction/">Introduction</a>
</li>
                                    
<li >
    <a href="../overview/">Overview of the Faust Universe</a>
</li>
                                    
<li >
    <a href="../quick-start/">Quick start</a>
</li>
                                    
<li >
    <a href="../syntax/">Faust Syntax</a>
</li>
                                    
<li >
    <a href="../compiler/">Using the Compiler</a>
</li>
                                    
<li >
    <a href="../options/">Compiler Options</a>
</li>
                                    
<li >
    <a href="../tools/">faust2[...] Tools</a>
</li>
                                    
<li >
    <a href="../embedding/">Embedding</a>
</li>
                                    
<li class="active">
    <a href="./">Optimizing</a>
</li>
                                    
<li >
    <a href="../osc/">OSC Support</a>
</li>
                                    
<li >
    <a href="../http/">HTTP Support</a>
</li>
                                    
<li >
    <a href="../midi/">MIDI Support</a>
</li>
                                    
<li >
    <a href="../soundfiles/">Soundfiles Support</a>
</li>
                                    
<li >
    <a href="../mathdoc/">Mathematical Documentation</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../examples/ambisonics/"> ambisonics </a>
</li>
                                    
<li >
    <a href="../../examples/analysis/"> analysis </a>
</li>
                                    
<li >
    <a href="../../examples/bela/"> bela </a>
</li>
                                    
<li >
    <a href="../../examples/delayEcho/"> delayEcho </a>
</li>
                                    
<li >
    <a href="../../examples/dynamic/"> dynamic </a>
</li>
                                    
<li >
    <a href="../../examples/filtering/"> filtering </a>
</li>
                                    
<li >
    <a href="../../examples/gameaudio/"> gameaudio </a>
</li>
                                    
<li >
    <a href="../../examples/generator/"> generator </a>
</li>
                                    
<li >
    <a href="../../examples/misc/"> misc </a>
</li>
                                    
<li >
    <a href="../../examples/phasing/"> phasing </a>
</li>
                                    
<li >
    <a href="../../examples/physicalModeling/"> physicalModeling </a>
</li>
                                    
<li >
    <a href="../../examples/pitchShifting/"> pitchShifting </a>
</li>
                                    
<li >
    <a href="../../examples/psychoacoustic/"> psychoacoustic </a>
</li>
                                    
<li >
    <a href="../../examples/reverb/"> reverb </a>
</li>
                                    
<li >
    <a href="../../examples/SAM/"> SAM </a>
</li>
                                    
<li >
    <a href="../../examples/smartKeyboard/"> smartKeyboard </a>
</li>
                                    
<li >
    <a href="../../examples/spat/"> spat </a>
</li>
                                    
<li >
    <a href="../../rsrc/examples.zip"> Download examples </a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../workshops/2020-04-10-faust-juce/">Faust & JUCE</a>
</li>
                                    
<li >
    <a href="../../tutorials/teensy/">DSP on the Teensy With Faust</a>
</li>
                                    
<li >
    <a href="../../tutorials/esp32/">DSP on the ESP-32 With Faust</a>
</li>
                                    
<li >
    <a href="../../tutorials/basic-osc/">Making a Sine Oscillator From Scratch</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Workshops <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../workshops/2018-12-01-paw/"> 2018-12-01 PAW </a>
</li>
                                    
<li >
    <a href="../../workshops/2020-03-24-faust-citi/"> 2020-03-24 CITI </a>
</li>
                                    
<li >
    <a href="../../workshops/2020-04-10-faust-101/"> 2020-04-10 Faust 101 </a>
</li>
                                    
<li >
    <a href="../../workshops/2020-04-10-faust-juce/"> 2020-04-10 Faust & JUCE </a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../about/">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../embedding/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../osc/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#tools-to-help-debug-and-optimize-the-generated-code">Tools to Help Debug and Optimize the Generated Code</a></li>
            <li><a href="#debugging-the-dsp-code">Debugging the DSP Code</a></li>
            <li><a href="#optimizing-the-dsp-code">Optimizing the DSP Code</a></li>
            <li><a href="#optimizing-the-c-or-llvm-code">Optimizing the C++ or LLVM Code</a></li>
            <li><a href="#compiling-for-multiple-cpu">Compiling for Multiple CPU</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="tools-to-help-debug-and-optimize-the-generated-code">Tools to Help Debug and Optimize the Generated Code</h1>
<p>From a given DSP program, the Faust compiler tries to generate the most efficient implementation. Optimizations can be done at DSP writing time, or later on when the target langage is generated (like  C++ or LLVM IR).
The generated code can have different "shapes" depending of compilation options, and can run faster of slower. Several programs and tools are available to help Faust programmers to test (for possible numerical or precision issues), optimize their programs by discovering the best set of options for a given DSP code, and finally compile them into native code for the target CPUs. </p>
<h2 id="debugging-the-dsp-code">Debugging the DSP Code</h2>
<p>The Faust compiler gives error messages when the written code is not syntactically or semantically correct. When a correct program is finally generated, it may still have numerical or precision issues only appearing at runtime. This typically happens when using mathematical functions outside of their definition domain, like calling <code>log(0)</code> or <code>sqrt(-1)</code> at some point in the signal path. Those errors have to be then fixed by carefully checking signal range, like verifying the min/max values in <code>vslider/hslider/nentry</code> user-interface items. One way to detect and understand them is by running the code in a controlled and instrumented environment. A special version of the <code>interpreter</code> backend can be used for that purpose and is embedded in a dedicated testing tool. </p>
<h3 id="interp-tracer">interp-tracer</h3>
<p>The <code>interp-tracer</code> tool runs and instruments the compiled program using the Interpreter backend. Various statistics on the code are collected and displayed while running and/or when closing the application, typically <code>FP_SUBNORMAL</code>, <code>FP_INFINITE</code> and <code>FP_NAN</code> values, or <code>INTEGER_OVERFLOW</code> and <code>DIV_BY_ZERO</code> operations. Mode 4 and 5 allow to display the stack trace of the running code when <code>FP_INFINITE</code>, <code>FP_NAN</code> or <code>INTEGER_OVERFLOW</code> values are produced. The <em>-control</em> mode allows to check control parameters, by explicitly setting their <em>min</em> and <em>max</em> values, then running the DSP and setting all controllers (inside their range) in a random way. Mode 4 up to 7 also check LOAD/STORE errors, and are typically used by the Faust compiler developers to check the generated code. A more complete documentation is available on the <a href="https://github.com/grame-cncm/faust/tree/master-dev/tools/benchmark#interp-tracer">this page</a>.</p>
<h3 id="debugging-at-runtime">Debugging at runtime</h3>
<p>On macOS, the <a href="https://faustdoc.grame.fr/manual/tools/#faust2caqt">faust2caqt</a> script has a <code>-me</code> option to catch math computation exceptions (floating point exceptions and integer div-by-zero or overflow) at runtime. Developers can possibly use the <a href="me-cncm/faust/blob/master-dev/architecture/faust/dsp/dsp-checker.h#L42">dsp_me_checker</a> class to decorate a given DSP objet with the math computation exception handling code. </p>
<h2 id="optimizing-the-dsp-code">Optimizing the DSP Code</h2>
<h3 id="writing-efficient-dsp-code">Writing efficient DSP code</h3>
<p>TODO</p>
<h3 id="specializing-the-dsp-code">Specializing the DSP code</h3>
<p>The Faust compiler can possibly do a lot of optimizations at compile time. The DSP code can for instance be compiled for a fixed sample rate, thus doing at compile time all computation that depends of it. Since the Faust compiler will look for librairies starting from the local folder, a simple way is to locally copy the <code>libraries/platform.lib</code> file (which contains the <code>SR</code> definition), and change its definition for a fixed value like 48000 Hz. Then the DSP code has to be recompiled. Note that <code>libraries/platform.lib</code> also contains the definition of  the <code>tablesize</code> constant which is used in various places to allocate tables for oscillators. Thus decreasing this value can save memory, for instance when compiling for embedded devices. This is the technique used in some Faust services scripts which add the <code>-I /usr/local/share/faust/embedded/</code> parameter to the faust command line to use a special version of the platform.lib file.</p>
<h2 id="optimizing-the-c-or-llvm-code">Optimizing the C++ or LLVM Code</h2>
<p>By default the Faust compiler produces a big scalar loop in the generated <code>mydsp::compute</code> method. Compiler options allow to generate other code "shape", like for instance separated simpler loops connected with buffers in the so-called vectorized mode (obtained using  the <code>-vec</code> option). The assumption is that auto-vectorizer passes in modern compilers will be able to better generate efficient SIMD code for them. In this vec option, the size of the internal buffer can be changed using the <code>-vs value</code> option. Moreover the computation graph can be organized in deep-first order using <code>-dfs</code>.  A lot of other compilation choices are fully controllable with options. Note that the C/C++ and LLVM backends are the one with the maximum of possible compilation options. </p>
<p>Manually testing each of them and their combination is out of reach. So several tools have been developed to automatize that process and help search the configuration space to discover the best set of compilation options: </p>
<h3 id="faustbench">faustbench</h3>
<p>The <code>faustbench</code> tool uses the C++ backend to generate a set of C++ files produced with different Faust compiler options. All files are then compiled in a unique binary that will measure DSP CPU of all versions of the compiled DSP. The tool is supposed to be launched in a terminal, but it can be used to generate an iOS project, ready to be launched and tested in Xcode. A more complete documentation is available on the <a href="https://github.com/grame-cncm/faust/tree/master-dev/tools/benchmark#faustbench">this page</a>.</p>
<h3 id="faustbench-llvm">faustbench-llvm</h3>
<p>The <code>faustbench-llvm</code> tool uses the <code>libfaust</code> library and its LLVM backend to dynamically compile DSP objects produced with different Faust compiler options, and then measure their DSP CPU usage. Additional Faust compiler options can be given beside the ones that will be automatically explored by the tool. A more complete documentation is available on the <a href="https://github.com/grame-cncm/faust/tree/master-dev/tools/benchmark#faustbench-llvm">this page</a>.</p>
<p>Some <strong>faust2xx</strong> tools like <a href="https://github.com/grame-cncm/faust/tree/master-dev/architecture/max-msp"><code>faust2max6</code></a> or <code>faust2caqt</code> can internally call the <code>faustbench-llvm</code> tool to discover and later on use the best possible compilation options. Remember that all <code>faust2xx</code> tools compile in scalar mode by default, but can take any combination of optimal options (like <code>-vec -fun -vs 32 -dfs -mcd 32</code> for instance) the previously described tools will automatically find.</p>
<h2 id="compiling-for-multiple-cpu">Compiling for Multiple CPU</h2>
<p>On modern CPUs, compiling native code dedicated to the target processor is critical to obtain the best possible performances. When using the C++ backend, the same C++ file can be compiled with <code>gcc</code> of <code>clang</code> for each possible target CPU using the appropriate <code>-march=cpu</code> option. When using the LLVM backend, the same LLVM IR code can be compiled into CPU specific machine code using the <code>dynamic-faust</code> tool. This step will typically be done using the best compilation options automatically found with the <code>faustbench</code> tool or <code>faustbench-llvm</code> tools. A specialized tool has been developed to combine all the possible options.</p>
<h3 id="faust2object">faust2object</h3>
<p>The <code>faust2object</code> tool  either uses the standard C++ compiler or the LLVM dynamic compilation chain (the <code>dynamic-faust</code> tool) to compile a Faust DSP to object code files (.o) and wrapper C++ header files for different CPUs. The DSP name is used in the generated C++ and object code files, thus allowing to generate distinct versions of the code that can finally be linked together in a single binary. A more complete documentation is available on the <a href="https://github.com/grame-cncm/faust/tree/master-dev/tools/benchmark#faust2object">this page</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 <a href="https://www.grame.fr">Grame-CNCM</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
